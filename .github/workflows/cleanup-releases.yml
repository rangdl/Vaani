name: Release Management
on:
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        keep: [5, 10, 20]  # 不同保留策略
    steps:
      - uses: actions/checkout@v4
      
      - name: Clean Releases
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // 配置
            const keepLatest = ${{ matrix.keep }};
            const keepYoungerThanDays = 30;
            const now = new Date();
            
            // 过滤和排序
            const sortedReleases = releases
              .filter(release => !release.draft)  // 跳过草稿
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            let deleted = 0;
            for (let i = 0; i < sortedReleases.length; i++) {
              const release = sortedReleases[i];
              const created = new Date(release.created_at);
              const ageDays = (now - created) / (1000 * 60 * 60 * 24);
              
              // 保留条件
              if (i < keepLatest || ageDays < keepYoungerThanDays) {
                console.log(`保留: ${release.tag_name} (${ageDays.toFixed(0)} 天)`);
                continue;
              }
              
              // 删除
              console.log(`删除: ${release.tag_name} (${ageDays.toFixed(0)} 天)`);
              try {
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id
                });
                deleted++;
              } catch (error) {
                console.error(`删除失败: ${error.message}`);
              }
            }
            
            console.log(`总计删除了 ${deleted} 个 release`);